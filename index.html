<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Generated Water Supply Planner</title>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #2563eb;
            --primary-dark: #1e40af;
            --secondary: #64748b;
            --accent: #06b6d4;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --text-muted: #64748b;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --font-family: 'Inter', sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-main);
            line-height: 1.6;
            padding-bottom: 40px;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
            color: white;
            padding: 2.5rem 1rem;
            text-align: center;
            margin-bottom: 2rem;
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            letter-spacing: -0.025em;
        }

        header p {
            color: #94a3b8;
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Container & Grid */
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        /* Card Styles */
        .card {
            background: var(--card-bg);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            border: 1px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .card:hover {
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #f1f5f9;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-main);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        /* Form Controls */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-muted);
        }

        input,
        select {
            padding: 0.75rem;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus,
        select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            gap: 0.5rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
            width: 100%;
            margin-top: 1.5rem;
            font-size: 1.1rem;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* Stats Dashboard */
        .stats-grid {
            display: flex !important;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 1rem;
            width: 100%;
        }

        .stat-card {
            flex: 1 1 180px;
            /* Grow to fill, shrink if needed, base 180px */
            min-width: 160px;
            /* Allow shrinking a bit more */
            /* No max-width */
        }

        .stat-card {
            background: #fff;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            border-left: 4px solid var(--secondary);
        }

        .stat-card.success {
            border-left-color: var(--success);
        }

        .stat-card.danger {
            border-left-color: var(--danger);
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-main);
        }

        /* Layout for Map & AI */
        .split-view {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
        }

        @media (max-width: 1024px) {
            .split-view {
                grid-template-columns: 1fr;
            }
        }

        /* Map */
        #map {
            height: 600px;
            width: 100%;
            border-radius: var(--border-radius);
            z-index: 1;
        }

        /* AI Analysis Panel */
        .ai-panel {
            background: linear-gradient(to bottom, #f8fafc, #fff);
            font-size: 0.95rem;
            height: 600px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
        }

        .ai-content {
            white-space: pre-wrap;
            line-height: 1.7;
            color: #334155;
        }

        .ai-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            font-style: italic;
            gap: 0.5rem;
        }

        /* Loading Spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Table Styles */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        th,
        td {
            text-align: left;
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--text-muted);
        }

        tr:last-child td {
            border-bottom: none;
        }

        /* Legend */
        .legend {
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            line-height: 1.5;
            color: #333;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            font-size: 13px;
        }

        .legend i {
            display: inline-block;
            width: 18px;
            height: 18px;
            margin-right: 8px;
            vertical-align: middle;
        }

        /* Footer */
        footer {
            text-align: center;
            margin-top: 3rem;
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .badge {
            display: inline-block;
            padding: 0.25em 0.6em;
            font-size: 75%;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.375rem;
            color: #fff;
        }

        .badge-success {
            background-color: var(--success);
        }

        .badge-warning {
            background-color: var(--warning);
        }

        .badge-danger {
            background-color: var(--danger);
        }
    </style>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet Routing Machine -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <style>
        .leaflet-routing-container {
            display: none !important;
        }
    </style>
</head>

<body>

    <header>
        <h1>AI Water Supply Planner</h1>
        <p>Advanced simulation & AI-driven analysis for emergency water distribution.</p>
    </header>

    <div class="container">

        <!-- CONFIGURATION CARD -->
        <section class="card">
            <div class="card-header">
                <div class="card-title">‚öôÔ∏è Simulation Parameters</div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="scenarioType">Scenario Type</label>
                    <select id="scenarioType">
                        <option value="drought">Severe Drought</option>
                        <option value="contamination">Water Contamination</option>
                        <option value="pipeline">Pipeline Infrastructure Failure</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="population" title="Total number of people affected in the region">Population</label>
                    <input type="number" id="population" value="85000" min="1000">
                </div>
                <div class="form-group">
                    <label for="lpcd" title="Liters Per Capita per Day (Emergency Target)">Target LPCD (Liters)</label>
                    <input type="number" id="lpcd" value="40" min="10">
                </div>
                <div class="form-group">
                    <label for="tankers">Available Tankers</label>
                    <input type="number" id="tankers" value="12" min="1">
                </div>
                <div class="form-group">
                    <label for="capacity">Tanker Capacity (L)</label>
                    <input type="number" id="capacity" value="12000" min="1000">
                </div>
                <div class="form-group">
                    <label for="borewells">Active Borewells</label>
                    <input type="number" id="borewells" value="6" min="0">
                </div>
            </div>
            <button class="btn btn-primary" id="generateBtn">
                <span>üöÄ Run Simulation & AI Analysis</span>
            </button>
        </section>

        <!-- DASHBOARD STATS -->
        <section class="stats-grid" id="statsSection" style="display: none;">
            <div class="stat-card">
                <div class="stat-label">Total Water Demand</div>
                <div class="stat-value" id="dispDemand">0 L</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Supply Capacity</div>
                <div class="stat-value" id="dispSupply">0 L</div>
            </div>
            <div class="stat-card" id="cardGap">
                <div class="stat-label">Water Deficit (Gap)</div>
                <div class="stat-value" id="dispGap">0 L</div>
            </div>
            <div class="stat-card" id="cardCoverage">
                <div class="stat-label">Coverage Ratio</div>
                <div class="stat-value" id="dispCoverage">0%</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Borewell Contribution</div>
                <div class="stat-value" id="dispBorewell">0 L</div>
            </div>
        </section>

        <!-- SPLIT VIEW: MAP & AI -->
        <div class="split-view" id="mainResults" style="display: none;">

            <!-- LEFT: MAP -->
            <section class="card" style="padding: 0; overflow: hidden;">
                <div id="map"></div>
            </section>

            <!-- RIGHT: AI ANALYSIS -->
            <section class="card ai-panel">
                <div class="card-header" style="position: sticky; top: 0; background: #fff; z-index: 10;">
                    <div class="card-title">ü§ñ AI Strategic Insights</div>
                </div>
                <div id="aiOutput" class="ai-content" style="padding: 1rem;">
                    <div class="ai-loading">Waiting for simulation data...</div>
                </div>
            </section>
        </div>

        <!-- DETAILS TABLES -->
        <section class="card" id="detailsSection" style="display: none;">
            <div class="card-header">
                <div class="card-title">üìã Detailed Logistics</div>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Zone ID</th>
                            <th>Status</th>
                            <th>Population</th>
                            <th>Demand (L)</th>
                            <th>Allocated Tankers</th>
                            <th>Supplied (L)</th>
                            <th>Deficit (L)</th>
                        </tr>
                    </thead>
                    <tbody id="zoneTable">
                        <!-- JS populated -->
                    </tbody>
                </table>
            </div>
        </section>

    </div>

    <footer>
        <p>Built with Leaflet.js, OSRM, and Groq AI Model Llama 3.</p>
    </footer>

    <!-- CONFIGURATION -->
    <script src="config.js"></script>

    <!-- LOGIC SCRIPT -->
    <script>
        /**
         * APPLICATION CONFIGURATION
         * Loaded from config.js
         */

        /**
         * STATE MANAGEMENT
         */
        const State = {
            population: 0,
            lpcd: 0,
            tankers: 0,
            capacity: 0,
            borewells: 0,
            zones: [],
            stats: {},

            updateFromDOM() {
                this.population = parseInt(document.getElementById('population').value) || 0;
                this.lpcd = parseInt(document.getElementById('lpcd').value) || 0;
                this.tankers = parseInt(document.getElementById('tankers').value) || 0;
                this.capacity = parseInt(document.getElementById('capacity').value) || 0;
                this.borewells = parseInt(document.getElementById('borewells').value) || 0;
                this.scenario = document.getElementById('scenarioType').value;
            },

            isValid() {
                return this.population > 0 && this.lpcd > 0 && this.tankers > 0;
            }
        };

        /**
         * SIMULATION LOGIC
         */
        const Simulation = {
            run() {
                // 1. Calculate Baselines
                const totalDemand = State.population * State.lpcd;

                // Simulate Borewell Yield (Random but realistic: 10k - 50k liters/day)
                let totalBorewellYield = 0;
                for (let i = 0; i < State.borewells; i++) {
                    totalBorewellYield += Math.floor(Math.random() * 40000) + 10000;
                }

                // Tanker Supply
                const totalTankerSupply = State.tankers * State.capacity;
                const totalSupply = totalTankerSupply + totalBorewellYield;

                // Stats
                let gap = totalDemand - totalSupply;
                if (gap < 0) gap = 0;
                const coverage = (totalSupply / totalDemand) * 100;

                State.stats = {
                    totalDemand,
                    totalTankerSupply,
                    totalBorewellYield,
                    totalSupply,
                    gap,
                    coverage
                };

                // 2. Generate Zones with varied needs
                State.zones = this.generateZones(5); // Create 5 active zones

                // Distribute resources logic (Simple heuristic)
                this.distributeResources();
            },

            generateZones(count) {
                const zones = [];
                const zoneNames = ['North Sector', 'South Sector', 'East Industrial', 'West Residential', 'Central Hub'];

                // Distribute population somewhat randomly
                let remainingPop = State.population;

                for (let i = 0; i < count; i++) {
                    // Coordinates around base
                    const angle = (i / count) * Math.PI * 2;
                    const radius = 0.03; // ~3-4km
                    const lat = CONFIG.baseLat + radius * Math.cos(angle);
                    const lng = CONFIG.baseLng + radius * Math.sin(angle);

                    // Pop logic
                    let zonePop = Math.floor(remainingPop / (count - i));
                    // Add some variance
                    if (i < count - 1) {
                        const variance = Math.floor(zonePop * 0.4); // +/- 40%
                        zonePop += Math.floor(Math.random() * variance * 2) - variance;
                    }
                    remainingPop -= zonePop;

                    zones.push({
                        id: i + 1,
                        name: zoneNames[i],
                        lat: lat,
                        lng: lng,
                        population: zonePop,
                        demand: zonePop * State.lpcd,
                        allocatedTankers: 0,
                        supplied: 0,
                        deficit: 0
                    });
                }
                return zones;
            },

            distributeResources() {
                let availableTankers = State.tankers;
                // Sort zones by demand (highest first) to prioritize
                // In a real app, we might prioritize by criticality (e.g., hospitals)
                const sortedZones = [...State.zones].sort((a, b) => b.demand - a.demand);

                // Distribute evenly first, then remainder
                const baseAlloc = Math.floor(availableTankers / State.zones.length);
                let remainder = availableTankers % State.zones.length;

                State.zones.forEach(z => {
                    let alloc = baseAlloc;
                    if (remainder > 0) {
                        alloc++;
                        remainder--;
                    }
                    z.allocatedTankers = alloc;

                    // Assume borewells are somewhat distributed, adding base supply
                    const localBorewell = (State.stats.totalBorewellYield / State.zones.length);

                    z.supplied = (alloc * State.capacity) + localBorewell;
                    z.deficit = z.demand - z.supplied;
                    if (z.deficit < 0) z.deficit = 0;

                    z.status = z.deficit === 0 ? 'Optimal' : (z.deficit / z.demand < 0.3 ? 'Stressed' : 'Critical');
                });
            }
        };

        /**
         * MAP CONTROLLER (Leaflet)
         */
        /**
         * MAP CONTROLLER (Leaflet)
         */
        const MapController = {
            map: null,
            layerGroup: null,

            init() {
                if (this.map) return; // Already initialized

                this.map = L.map('map').setView([CONFIG.baseLat, CONFIG.baseLng], 12);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(this.map);

                this.layerGroup = L.layerGroup().addTo(this.map);

                this.addLegend();
            },

            addLegend() {
                const legend = L.control({ position: 'bottomright' });
                legend.onAdd = function (map) {
                    const div = L.DomUtil.create('div', 'legend');
                    div.innerHTML = `
                        <strong>Simulation Map Legend</strong><br>
                        <i style="background:var(--primary); border-radius:50%"></i> Central Depot<br>
                        <i style="background:var(--danger); border-radius:50%"></i> Critical Zone<br>
                        <i style="background:var(--warning); border-radius:50%"></i> Stressed Zone<br>
                        <i style="background:var(--success); border-radius:50%"></i> Optimal Zone<br>
                        <i style="border-bottom: 2px dashed red"></i> Pending Delivery
                    `;
                    return div;
                };
                legend.addTo(this.map);
            },

            render() {
                this.layerGroup.clearLayers();

                // Add Central Depot
                const depotIcon = L.divIcon({
                    className: 'custom-icon',
                    html: `<div style="font-size:30px">üè¢</div>`,
                    iconSize: [30, 30]
                });

                L.marker([CONFIG.baseLat, CONFIG.baseLng], { icon: depotIcon })
                    .bindPopup('<b>Central Water Depot</b><br>Supply Hub')
                    .addTo(this.layerGroup);

                // Add Zones
                State.zones.forEach(z => {
                    let color = 'green';
                    if (z.status === 'Critical') color = 'red';
                    if (z.status === 'Stressed') color = 'orange';

                    // Zone Circle
                    L.circle([z.lat, z.lng], {
                        color: color,
                        fillColor: color,
                        fillOpacity: 0.3,
                        radius: 800
                    }).addTo(this.layerGroup)
                        .bindPopup(`<b>${z.name}</b><br>Pop: ${z.population.toLocaleString()}<br>Deficit: ${Math.round(z.deficit).toLocaleString()} L`);

                    // Routing Visualization
                    if (z.allocatedTankers > 0) {
                        this.drawRoute(z, color);
                    }
                });

                // Force resize fix
                setTimeout(() => this.map.invalidateSize(), 100);
            },

            drawRoute(zone, color) {
                const start = L.latLng(CONFIG.baseLat, CONFIG.baseLng);
                const end = L.latLng(zone.lat, zone.lng);

                // Try OSRM Routing
                const routeControl = L.Routing.control({
                    waypoints: [start, end],
                    router: L.Routing.osrmv1({
                        serviceUrl: 'https://router.project-osrm.org/route/v1',
                        timeout: 5000 // 5s timeout
                    }),
                    lineOptions: {
                        styles: [{ color: color, opacity: 0.6, weight: 4, dashArray: '10,10' }]
                    },
                    createMarker: () => null,
                    addWaypoints: false,
                    show: false,
                    fitSelectedRoutes: false
                }).addTo(this.map);

                // Success Handler
                routeControl.on('routesfound', (e) => {
                    const route = e.routes[0];
                    const coords = route.coordinates;
                    const durationSeconds = route.summary.totalTime;
                    const durationMins = Math.round(durationSeconds / 60);

                    this.animateTanker(coords, durationMins, zone.name);
                });

                // Error Handler (Fallback to straight line)
                routeControl.on('routingerror', () => {
                    // console.warn("Routing API failed. Using direct path fallback.");
                    this.drawFallbackRoute(start, end, color, zone.name);
                });
            },

            drawFallbackRoute(start, end, color, zoneName) {
                // Draw dotted line
                L.polyline([start, end], {
                    color: color,
                    opacity: 0.6,
                    weight: 4,
                    dashArray: '10,10'
                }).addTo(this.layerGroup);

                // Generate points for animation
                const points = [];
                const steps = 100;
                for (let i = 0; i <= steps; i++) {
                    points.push(L.latLng(
                        start.lat + (end.lat - start.lat) * (i / steps),
                        start.lng + (end.lng - start.lng) * (i / steps)
                    ));
                }
                this.animateTanker(points, "N/A (Direct)", zoneName);
            },

            animateTanker(coords, eta, zoneName) {
                const icon = L.divIcon({
                    html: '<div style="font-size:24px">üöõ</div>',
                    className: 'tanker-anim',
                    iconSize: [24, 24]
                });

                const marker = L.marker(coords[0], { icon })
                    .addTo(this.layerGroup)
                    .bindPopup(`<b>Water Tanker</b><br>Dest: ${zoneName}<br>ETA: ${eta} mins`)
                    .openPopup();

                let i = 0;
                function move() {
                    if (i < coords.length) {
                        marker.setLatLng(coords[i]);
                        // Update ETA real-time simulation if we wanted, but static is fine for now
                        i++;
                        setTimeout(() => requestAnimationFrame(move), 50); // 50ms delay for slower movement
                    }
                }
                move();
            }
        };

        /**
         * AI MANAGER (Groq API)
         */
        const AIManager = {
            async analyze() {
                const ui = document.getElementById('aiOutput');
                ui.innerHTML = `
                    <div class="ai-loading">
                        <div class="spinner"></div> 
                        Generating strategic analysis plan...
                    </div>`;

                const prompt = this.constructPrompt();

                try {
                    const response = await fetch(CONFIG.groqApiUrl, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${CONFIG.groqApiKey}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            model: "llama-3.3-70b-versatile",
                            messages: [
                                {
                                    role: "system",
                                    content: "You are an expert logistician and emergency response coordinator. Analyze the water supply simulation data and provide a concise, professional report. Use bolding for key metrics. Focus on actionable insights."
                                },
                                {
                                    role: "user",
                                    content: prompt
                                }
                            ],
                            temperature: 0.7,
                            max_tokens: 600
                        })
                    });

                    const data = await response.json();

                    if (!response.ok) {
                        const errorMsg = data.error?.message || data.message || "Unknown API Error";
                        throw new Error(`API Error ${response.status}: ${errorMsg}`);
                    }

                    if (data.choices && data.choices.length > 0) {
                        const text = data.choices[0].message.content;
                        // Simple markdown formatting to HTML
                        const formatted = text
                            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                            .replace(/### (.*?)\n/g, '<h3>$1</h3>')
                            .replace(/- (.*?)\n/g, '<li>$1</li>');

                        ui.innerHTML = formatted;
                    } else {
                        throw new Error("No response content from AI");
                    }

                } catch (err) {
                    console.error("Full AI Error:", err);
                    ui.innerHTML = `<div style="color:var(--danger)">‚ö†Ô∏è AI Status: ${err.message}</div>`;
                }
            },

            constructPrompt() {
                const s = State.stats;
                let criticalZones = State.zones.filter(z => z.status === 'Critical').map(z => z.name).join(', ');
                if (!criticalZones) criticalZones = "None";

                return `
                    Scenario: ${State.scenario}
                    Total Population: ${State.population}
                    Daily Demand: ${s.totalDemand} Liters
                    Current Supply: ${s.totalSupply} Liters
                    Gap: ${s.gap} Liters
                    Coverage: ${s.coverage.toFixed(1)}%
                    Tankers Deployed: ${State.tankers}
                    Critical Zones: ${criticalZones}

                    Please provide:
                    1. Executive Summary of the situation.
                    2. Strategic Recommendations to close the gap.
                    3. Specific advice for the critical zones.
                `;
            }
        };

        /**
         * UI MANAGER
         */
        const UIManager = {
            init() {
                document.getElementById('generateBtn').addEventListener('click', () => {
                    this.handleRun();
                });
            },

            handleRun() {
                State.updateFromDOM();

                if (!State.isValid()) {
                    alert("Please enter valid positive numbers for population, lpcd, and tankers.");
                    return;
                }

                // Show UI sections
                document.getElementById('statsSection').style.display = 'flex';
                document.getElementById('mainResults').style.display = 'grid';
                document.getElementById('detailsSection').style.display = 'block';

                // Run Sim
                Simulation.run();

                // Update Stats
                this.updateStats();

                // Update Table
                this.updateTable();

                // Init & Render Map
                MapController.init();
                MapController.render();

                // Run AI
                AIManager.analyze();
            },

            updateStats() {
                const s = State.stats;
                const fmt = (n) => Math.round(n).toLocaleString() + ' L';

                document.getElementById('dispDemand').textContent = fmt(s.totalDemand);
                document.getElementById('dispSupply').textContent = fmt(s.totalSupply);
                document.getElementById('dispGap').textContent = fmt(s.gap);
                document.getElementById('dispBorewell').textContent = fmt(s.totalBorewellYield);

                const covEl = document.getElementById('dispCoverage');
                covEl.textContent = s.coverage.toFixed(1) + '%';

                // Color coding
                const cardGap = document.getElementById('cardGap');
                const cardCov = document.getElementById('cardCoverage');

                if (s.coverage >= 100) {
                    cardCov.parentElement.className = 'stat-card success';
                    cardGap.parentElement.className = 'stat-card success';
                } else if (s.coverage > 70) {
                    cardCov.parentElement.className = 'stat-card'; // neutral/blue
                } else {
                    cardCov.parentElement.className = 'stat-card danger';
                }
            },

            updateTable() {
                const tbody = document.getElementById('zoneTable');
                tbody.innerHTML = '';

                State.zones.forEach(z => {
                    let badgeClass = 'badge-success';
                    if (z.status === 'Critical') badgeClass = 'badge-danger';
                    if (z.status === 'Stressed') badgeClass = 'badge-warning';

                    const row = `
                        <tr>
                            <td>${z.name}</td>
                            <td><span class="badge ${badgeClass}">${z.status}</span></td>
                            <td>${z.population.toLocaleString()}</td>
                            <td>${z.demand.toLocaleString()}</td>
                            <td>${z.allocatedTankers}</td>
                            <td>${z.supplied.toLocaleString()}</td>
                            <td style="color:${z.deficit > 0 ? 'var(--danger)' : 'var(--text-muted)'}">${Math.floor(z.deficit).toLocaleString()}</td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        };

        // Initialize App
        window.addEventListener('DOMContentLoaded', () => {
            UIManager.init();
        });

    </script>
</body>

</html>